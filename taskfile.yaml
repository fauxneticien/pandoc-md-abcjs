version: '3'

tasks:
  build:
    desc: Build a markdown file to HTML using pandoc
    vars:
      INPUT: '{{.INPUT | default "docs/posts/2026-01-24/index.md"}}'
    cmds:
      - pandoc {{.INPUT}} -o {{.INPUT | replace ".md" ".html"}} --standalone --from markdown --to html5 --template=pandoc/templates/post.html --lua-filter=pandoc/passthrough.lua
    sources:
      - '{{.INPUT}}'
      - pandoc/templates/post.html
      - pandoc/passthrough.lua

  build-all:
    desc: Build all markdown files in docs/posts/ to HTML
    cmds:
      - for f in docs/posts/*/index.md; do task build INPUT="$f"; done
    silent: true

  generate-index:
    desc: Generate docs/index.html from posts folders
    cmds:
      - python3 pandoc/generate_index.py

  serve:
    desc: Launch livereload server for development
    cmds:
      - python -c "from livereload import Server; server = Server(); server.watch('docs/posts/**/*.md', 'task build-all'); server.watch('docs/**/*.html'); server.watch('docs/plugins/**/*.js'); server.watch('docs/plugins/**/*.css'); server.watch('pandoc/*.lua', 'task build-all'); server.serve(root='docs', port=8000, host='0.0.0.0')"

  watch:
    desc: Watch and rebuild .md files as they are edited using entr
    cmds:
      - find docs/posts -name '*.md' | entr -r task build-all

  dev:
    desc: Run both livereload server and file watcher
    deps:
      - serve
